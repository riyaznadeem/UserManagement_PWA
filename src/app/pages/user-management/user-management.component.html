<div class="container mt-4">
  <h2>{{ translate('userManagement.title') }}</h2>

  <div class="row mb-3">
    <!-- Search Input -->
    <div class="col-md-4">
      <input
        type="text"
        class="form-control"
        placeholder="{{ translate('userManagement.searchPlaceholder') }}"
        [(ngModel)]="searchTerm"
        (keyup.enter)="onSearch()"
      />
    </div>

    <!-- Role Filter -->
    <div class="col-md-4">
      <select class="form-select" [(ngModel)]="roleFilter" (change)="onSearch()">
        <option value="">{{ translate('userManagement.allRoles') }}</option>
        <option *ngFor="let role of roles" [value]="role.id">{{ role?.name }}</option>
      </select>
    </div>

    <!-- Search Button -->
    <div class="col-md-2">
      <button class="btn btn-primary w-100" (click)="onSearch()">
        {{ translate('userManagement.search') }}
      </button>
    </div>

    <!-- Add Button (Admin Only) -->
    <div class="col-md-2" *ngIf="accessRole === 'Admin'">
      <button
        type="button"
        class="btn btn-success w-100"
        data-bs-toggle="modal"
        data-bs-target="#addEditUserModal"
        (click)="openAddUser()"
      >
        {{ translate('userManagement.addUser') }}
      </button>
    </div>
  </div>

  <!-- User Table -->
  <table class="table table-bordered table-hover mt-3">
    <thead class="table-primary">
      <tr>
        <th (click)="onSort('Username')" style="cursor:pointer">
          {{ translate('userManagement.username') }}
          <i
            class="bi"
            *ngIf="sortBy === 'Username'"
            [ngClass]="sortDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill'"
          ></i>
        </th>
        <th (click)="onSort('DisplayName')" style="cursor:pointer">
          {{ translate('userManagement.displayName') }}
          <i
            class="bi"
            *ngIf="sortBy === 'DisplayName'"
            [ngClass]="sortDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill'"
          ></i>
        </th>
        <th (click)="onSort('RoleName')" style="cursor:pointer">
          {{ translate('userManagement.role') }}
          <i
            class="bi"
            *ngIf="sortBy === 'RoleName'"
            [ngClass]="sortDirection === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill'"
          ></i>
        </th>
        <th *ngIf="accessRole === 'Admin' || accessRole === 'User'">{{ translate('userManagement.action') }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of users">
        <td>{{ user.username }}</td>
        <td>{{ user.displayName }}</td>
        <td>{{ user.roleName }}</td>
        <td *ngIf="accessRole === 'Admin' || accessRole === 'User'">
          <!-- Edit Button -->
          <button
            class="btn btn-sm btn-info me-2"
            data-bs-toggle="modal"
            data-bs-target="#addEditUserModal"
            (click)="openEditUser(user)"
            title="{{ translate('userManagement.edit') }}"
          >
            <i class="bi bi-pencil-fill"></i> {{ translate('userManagement.edit') }}
          </button>

          <!-- Delete Button (Admin Only) -->
          <button
            *ngIf="accessRole === 'Admin'"
            class="btn btn-sm btn-danger"
            (click)="confirmDeleteUser(user)"
            title="{{ translate('userManagement.delete') }}"
          >
            <i class="bi bi-trash-fill"></i> {{ translate('userManagement.delete') }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav aria-label="User pagination">
    <ul class="pagination justify-content-end">
      <li class="page-item" [class.disabled]="pageNumber === 1">
        <a class="page-link" (click)="onPageChange(pageNumber - 1)">
          {{ translate('userManagement.previous') }}
        </a>
      </li>
      <li
        class="page-item"
        *ngFor="let page of totalPages"
        [class.active]="pageNumber === page"
      >
        <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
      </li>
      <li class="page-item" [class.disabled]="pageNumber === totalPages.length">
        <a class="page-link" (click)="onPageChange(pageNumber + 1)">
          {{ translate('userManagement.next') }}
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- Add/Edit User Modal -->
<div
  class="modal fade"
  id="addEditUserModal"
  tabindex="-1"
  aria-labelledby="addEditUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form [formGroup]="userForm" (ngSubmit)="saveUser()">
              <div class="modal-header">
          <h5 class="modal-title" id="addEditUserModalLabel">
            {{ isEditMode ? translate('userManagement.update') : translate('userManagement.create') }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ translate('userManagement.username') }}</label>
            <input type="text" class="form-control" formControlName="username" />
            <div
              *ngIf="userForm.get('username')?.touched && userForm.get('username')?.invalid"
              class="text-danger"
            >
              {{ translate('userManagement.usernameRequired') }}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ translate('userManagement.displayName') }}</label>
            <input type="text" class="form-control" formControlName="displayName" />
            <div
              *ngIf="userForm.get('displayName')?.touched && userForm.get('displayName')?.invalid"
              class="text-danger"
            >
              {{ translate('userManagement.displayNameRequired') }}
            </div>
          </div>

          <div class="mb-3" *ngIf="!isEditMode">
            <label class="form-label">{{ translate('userManagement.password') }}</label>
            <input type="password" class="form-control" formControlName="password" />
            <div
              *ngIf="userForm.get('password')?.touched && userForm.get('password')?.invalid"
              class="text-danger"
            >
              {{ translate('userManagement.passwordRequired') }}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ translate('userManagement.role') }}</label>
            <select class="form-select" formControlName="roleId">
              <option [value]="''">{{ translate('userManagement.selectRole') }}</option>
              <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
            </select>
            <div
              *ngIf="userForm.get('roleId')?.touched && userForm.get('roleId')?.invalid"
              class="text-danger"
            >
              {{ translate('userManagement.roleRequired') }}
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
            {{ isEditMode ? translate('userManagement.update') : translate('userManagement.create') }}
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {{ translate('userManagement.cancel') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
